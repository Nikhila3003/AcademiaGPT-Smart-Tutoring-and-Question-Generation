page_content='We will now use the data that we downloaded to explore the labor market reactions during times of economic turbulence  \n```python\nimport matplotlib.pyplot as plt\nimport numpy as np\nimport pandas as pd  \n%matplotlib inline\n```' metadata={'Header 1': 'BLS Labor Statistics'}page_content='We are going to assume that the data is stored in the same directory as you are in right now under `bls_metadata.parquet` and `bls_data.parquet`.  \n```python\ndata = pd.read_parquet("bls_data.parquet")\nmetadata = pd.read_parquet("bls_metadata.parquet")  \n```' metadata={'Header 1': 'BLS Labor Statistics', 'Header 2': 'Clean the data'}page_content='```python\ndata["value"] = pd.to_numeric(data["value"])\n```' metadata={'Header 1': 'BLS Labor Statistics', 'Header 2': 'Clean the data', 'Header 3': 'Convert to numeric data'}page_content='```python\ndata.head()\n```  \n```python\ndata["dt"] = pd.to_datetime(\ndata.apply(lambda x: f"1 {x[\'periodName\']} {x[\'year\']}", axis=1)\n)' metadata={'Header 1': 'BLS Labor Statistics', 'Header 2': 'Clean the data', 'Header 3': 'Convert date information to datetime'}page_content='data = data.drop(\n["year", "periodName", "period"], axis=1\n).sort_values(\n["series_id", "dt"]\n)[["series_id", "dt", "value"]]  \ndata.head(3)  \n```' metadata={'Header 1': 'Drop unneeded date info'}page_content='```python\nlfs_status = {\n"Employed": "employed",\n"Unemployed": "unemployed",\n"Labor Force Flows Employed to Employed": "ee",\n"Labor Force Flows Employed to Unemployed": "eu",\n"Labor Force Flows Unemployed to Employed": "ue",\n"Labor Force Flows Unemployed to Unemployed": "uu",\n}  \nmetadata = metadata.replace({"cps_labor_force_status": lfs_status})  \nmetadata.head(2)  \n```' metadata={'Header 1': 'Drop unneeded date info', 'Header 3': 'Rename `cps_labor_force_status`'}page_content='```python\nand_filters = [\n"(commerce_industry == \'All Industries\')",\n"(occupation == \'All Occupations\')",\n"(seasonality == \'Not Seasonally Adjusted\')",\n"(demographic_race == \'All Races\')",\n"(demographic_gender == \'Both Sexes\')",\n]  \nmetadata_lf = metadata.query(\n"&".join(and_filters)\n).loc[metadata["cps_labor_force_status"].isin(lfs_status.values()), :]  \nmetadata_lf.head(2)  \n```' metadata={'Header 1': 'Drop unneeded date info', 'Header 3': 'Only keep subset of metadata'}page_content='```python\ndf = pd.merge(\ndata, metadata_lf[["series_id", "cps_labor_force_status"]],\non="series_id", how="right"\n).rename(\ncolumns={"cps_labor_force_status": "variable"}\n)[["variable", "dt", "value"]]  \ndf.head()  \n```' metadata={'Header 1': 'Drop unneeded date info', 'Header 3': 'Merge variable names to `data`'}page_content='Create a function that will give us a series starting from a particular date and going forward a certain number of days  \n```python\ndef filter_days_from(data, start_date, ndays=3*365):\n"""\nCreates a history of data starting at a particular date and running\nforward for `ndays` days.  \nParameters\n----------\ndata : pd.DataFrame\nA DataFrame with relevant data that we\'d like to  consider\nstarting from a particular date. Must have a column `dt` with\ndatetime data\nstart_date : str or datetime\nThe moment we would like our history to start\nndays : int\nThe number of days that we would like to keep in our history  \nReturns\n-------\nout : pd.DataFrame\nA copy of `data` with only data from `start_date` to\n`start_date + f\'{ndays} days\'` and a new column that counts\nthe number of days since `start_date`\n"""' metadata={'Header 1': 'Drop unneeded date info', 'Header 2': 'Generate series from dates'}page_content='days_from = (data["dt"] - pd.to_datetime(start_date)).dt.days' metadata={'Header 1': 'Determine number of days from certain date'}page_content='dates_to_keep = (days_from >= 0) & (days_from < ndays)' metadata={'Header 1': 'Check for >=0 days and <ndays'}page_content='out = data.copy()\nout["days_from"] = days_from\nout = out.loc[dates_to_keep, :]  \nreturn out\n```' metadata={'Header 1': "Create copy of DataFrame that we'll use as the return"}page_content='```python\ndf_nt = filter_days_from(df, "2012-01-01", ndays=5*365)  \ndf_nt.head()  \n```' metadata={'Header 1': "Create copy of DataFrame that we'll use as the return", 'Header 3': 'What does this function do?'}page_content='```python\npt_nt = df_nt.pivot(index="dt", columns="variable", values="value")  \npt_nt["laborforce"] = pt_nt.eval("employed + unemployed")  \nfor col in ["ee", "eu"]:\npt_nt.loc[:, col] = pt_nt.eval(f"{col} / employed")  \nfor col in ["ue", "uu"]:\npt_nt.loc[:, col] = pt_nt.eval(f"{col} / unemployed")  \npt_nt.head()  \n```  \n```python\nfig, ax = plt.subplots(figsize=(10, 8))  \npt_nt.plot(\ny="eu", ax=ax,\ncolor="Red", legend=False, linewidth=2.0\n)\npt_nt.plot(\ny="ue", ax=ax,\ncolor="Green", legend=False, linewidth=2.0\n)  \nax.hlines(\npt_nt["eu"].mean(), pt_nt.index[0], pt_nt.index[-1],\nlinewidth=1.0, linestyle="--", color="Red"\n)\nax.hlines(\npt_nt["ue"].mean(), pt_nt.index[0], pt_nt.index[-1],\nlinewidth=1.0, linestyle="--", color="Green"\n)  \nxs, xe = ax.get_xlim()\nax.annotate(\n"EU", xy=(xs + 0.33*(xe-xs), 0.020),\ncolor="Red", size=16\n)\nax.annotate(\n"UE", xy=(xs + 0.15*(xe-xs), 0.22),\ncolor="Green", size=16\n)  \nax.spines["right"].set_visible(False)\nax.spines["top"].set_visible(False)  \nax.set_title("EU and UE during \'normal times\'", size=18)\n```' metadata={'Header 1': "Create copy of DataFrame that we'll use as the return", 'Header 2': "UE and EU during 'normal times'"}page_content='We are going to start our plots of "turbulent times" one year prior to the trough of unemployment...  \nNote that we did this approximately, but writing code to do this would be a great exercise if you\'re looking for practice!  \n```python\ndf_covid = filter_days_from(\ndf, "2019-03-01", 5*365\n).pivot(\nindex="days_from", columns="variable", values="value"\n).assign(\nlaborforce= lambda x: x.eval("employed + unemployed"),\nee=lambda x: x.eval("ee / employed"),\neu=lambda x: x.eval("eu / employed"),\nue=lambda x: x.eval("ue / unemployed"),\nuu=lambda x: x.eval("uu / unemployed"),\n)  \n```  \n```python\ndf_gr = filter_days_from(\ndf, "2007-02-01", 5*365\n).pivot(\nindex="days_from", columns="variable", values="value"\n).assign(\nlaborforce= lambda x: x.eval("employed + unemployed"),\nee=lambda x: x.eval("ee / employed"),\neu=lambda x: x.eval("eu / employed"),\nue=lambda x: x.eval("ue / unemployed"),\nuu=lambda x: x.eval("uu / unemployed"),\n)  \n```' metadata={'Header 1': "Create copy of DataFrame that we'll use as the return", 'Header 2': "Labor statistics during 'turbulent times'"}page_content='```python\nfig, ax = plt.subplots(2, 1, figsize=(10, 8), sharex=True)  \ndf_covid.plot(\ny="employed", ax=ax[0],\ncolor="k", linewidth=1.0, legend=False\n)\ndf_gr.plot(\ny="employed", ax=ax[0],\ncolor="k", alpha=0.5, linestyle="--", linewidth=0.5,\nlegend=False\n)\nax[0].set_title("Number of employed")\nax[0].set_ylabel("People in thousands")  \ndf_covid.plot(\ny="unemployed", ax=ax[1],\ncolor="k", linewidth=1.0, legend=False\n)\ndf_gr.plot(\ny="unemployed", ax=ax[1],\ncolor="k", alpha=0.5, linestyle="--", linewidth=0.5,\nlegend=False\n)\nax[1].set_title("Number of unemployed")\nax[1].set_xlabel("Days since one year before trough")\nax[1].set_ylabel("People in thousands")  \nfor _ax in ax:\n_ax.spines["right"].set_visible(False)\n_ax.spines["top"].set_visible(False)  \nax[0].annotate("COVID", (385, 155_000))\nax[0].annotate("Great Recession", (1_250, 142_000), alpha=0.5)  \nfig.tight_layout()\n```' metadata={'Header 1': "Create copy of DataFrame that we'll use as the return", 'Header 2': "Labor statistics during 'turbulent times'", 'Header 3': 'Changes in employment and unemployment'}page_content='```python\nfig, ax = plt.subplots(2, 1, figsize=(10, 8), sharex=True)  \ndf_covid.plot(\ny="ue", ax=ax[0],\ncolor="k", linewidth=1.0, legend=False\n)\ndf_gr.plot(\ny="ue", ax=ax[0],\ncolor="k", alpha=0.5, linestyle="--", linewidth=0.5,\nlegend=False\n)\nax[0].set_title("Unemployed to Employed")\nax[0].set_ylabel("Percent of unemployed")  \ndf_covid.plot(\ny="eu", ax=ax[1],\ncolor="k", linewidth=1.0, legend=False\n)\ndf_gr.plot(\ny="eu", ax=ax[1],\ncolor="k", alpha=0.5, linestyle="--", linewidth=0.5,\nlegend=False\n)\nax[1].set_title("Employed to Unmployed")\nax[1].set_xlabel("Days since one year before trough")\nax[1].set_ylabel("Percent of employed")  \nfor _ax in ax:\n_ax.spines["right"].set_visible(False)\n_ax.spines["top"].set_visible(False)  \nax[0].hlines(pt_nt["ue"].mean(), 0, 5*365, color="Green", linewidth=0.75, alpha=0.75)\nax[1].hlines(pt_nt["eu"].mean(), 0, 5*365, color="Green", linewidth=0.75, alpha=0.75)  \nax[0].annotate("COVID", (550, 0.35))\nax[0].annotate("Great Recession", (750, 0.10), alpha=0.5)\nax[0].annotate("Normal times", (1000, 0.24), color="Green", alpha=0.75)  \nfig.tight_layout()  \n```' metadata={'Header 1': "Create copy of DataFrame that we'll use as the return", 'Header 2': "Labor statistics during 'turbulent times'", 'Header 3': 'Changes in EU and UE'}