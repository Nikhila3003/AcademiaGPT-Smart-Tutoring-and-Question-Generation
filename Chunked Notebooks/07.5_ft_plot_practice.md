page_content='**Prerequisites**  \n- [Introduction](intro.ipynb)  \n**Outcomes**  \n- Be able to build visualizations with multiple subplots\n- Add plot elements using data from multiple DataFrames\n- Understand the relationship between the matplotlib Figure and Axes\nobjects\n- Customize fonts, legends, axis labels, tick labels, titles, and more!\n- Save figures to files to add to presentation, email, or use outside\nof a Jupyter notebook  \n**Data**  \n- iPhone announcement dates\n- Apple stock price  \n```python' metadata={'Header 1': 'Intermediate Plotting'}page_content='#! pip install qeds\n```  \n```python\nimport os\nimport numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport matplotlib\nimport matplotlib.transforms as transforms\nimport quandl  \nquandl.ApiConfig.api_key = os.environ.get("QUANDL_AUTH", "Dn6BtVoBhzuKTuyo6hbp")  \n%matplotlib inline' metadata={'Header 1': 'Uncomment following line to install on colab'}page_content='import qeds\nqeds.themes.mpl_style();\n```' metadata={'Header 1': 'activate plot theme'}page_content='- [Intermediate Plotting](#Intermediate-Plotting)\n- [Introduction](#Introduction)\n- [The Want Operator: Replicate a Professional Figure](#The-Want-Operator:-Replicate-a-Professional-Figure)\n- [Data](#Data)\n- [Warmup](#Warmup)\n- [Data Cleaning](#Data-Cleaning)\n- [Constructing the Plot](#Constructing-the-Plot)\n- [Saving the Figure](#Saving-the-Figure)\n- [Exercises](#Exercises)' metadata={'Header 1': 'activate plot theme', 'Header 2': 'Outline'}page_content='We have already seen a few examples of basic visualizations created\nusing the `.plot` method for a DataFrame.  \nWhen we use the `.plot` method, pandas uses a package called\nmatplotlib that actually creates the visualization.  \nIn this lecture, we will dive deeper into the customization options in\nthe DataFrame `.plot` method as well as look under the hood at how to\nuse matplotlib directly to unlock unlimited control over our figures.' metadata={'Header 1': 'activate plot theme', 'Header 2': 'Introduction'}page_content='Visualization is a complex subject.  \n[Many\nbooks](https://www.amazon.com/s/ref=nb_sb_noss?url=search-alias%3Dstripbooks&field-keywords=data+visualization&rh=n%3A283155%2Ck%3Adata+visualization)\nhave been written on the subject.  \nWe cannot hope to convey all of what is possible in a short lecture, so\nwe thought we’d try something fun instead.  \nOur goal in this lecture is to show off some of the common – and some\nnot-so-common – matplotlib capabilities to try to re-create this\nstriking figure from a Financial Times\n[article](https://www.ft.com/content/4743ce96-e4bf-11e7-97e2-916d4fbac0da).  \nThe figure shows how we can see the anticipation of and response to iPhone\nannouncements in Apple stock share prices.  \n<img src="https://datascience.quantecon.org/_images/aapl_iphone_announcments.png" alt="aapl\\_iphone\\_announcments.png" style="">  \nOur goal is to replicate the top portion of this figure in this lecture.  \n**Disclaimer**: Many tools you will see in this lecture will be\n“more advanced” than what you typically use when customizing a plot.\nDon’t (please!) try to memorize the commands used here – the purpose of\nthe lecture is to show what is possible and expose you a variety of the\nmethods you can use.' metadata={'Header 1': 'activate plot theme', 'Header 2': 'The Want Operator: Replicate a Professional Figure'}page_content='Let’s get the data.  \nFirst, we create a Series containing the date of each iPhone\nannouncement that appears in the FT original chart.  \nAs there have only been 11 of them and we couldn’t find this “dataset”\nonline anywhere, we will do this by hand.  \n```python\nannouncement_dates = pd.Series(\n[\n"First iPhone", "3G", "3GS", "4", "4S", "5", "5S/5C", "6/6 Plus",\n"6S/6S Plus", "7/7 Plus", "8/8 Plus/X"\n],\nindex=pd.to_datetime([\n"Jan. 9, 2007", "Jun. 9, 2008", "Jun. 8, 2009", "Jan. 11, 2011",\n"Oct. 4, 2011", "Sep. 12, 2012", "Sep. 10, 2013", "Sep. 9, 2014",\n"Sep. 9, 2015", "Sep. 7, 2016", "Sep. 12, 2017"\n]),\nname="Model"\n)\nannouncement_dates\n```  \nThen, let’s grab Apple’s stock price data from quandl, starting a few\nweeks before the first announcement.  \n```python\naapl = quandl.get("WIKI/AAPL", start_date="2006-12-25")\naapl.head()\n```' metadata={'Header 1': 'activate plot theme', 'Header 2': 'Data'}page_content="Matplotlib figures are composed two main types of Python objects:  \n1. `Figure`: represents the entirety of the visualization\n1. `Axes`: A (potentially full) subset of the figure on which things\nare drawn  \nMost of the time, we will customize our plots by calling methods on an\nAxes object.  \nHowever, things like setting a title over the entire plot or saving the\nplot to a file on your computer require methods on a `Figure`.  \nLet’s start by getting our hands dirty and practicing using these\nobjects.  \n<a id='exercise-0'></a>\n> See exercise 1 in the [*exercise list*](#exerciselist-0)  \nYou should have seen that the object returned by the `.plot` method is\na matplotlib Axes.  \nAs mentioned above, we can control most aspects of a plot by calling\nmethods on an Axes.  \nLet’s see some examples.  \n```python" metadata={'Header 1': 'activate plot theme', 'Header 2': 'Warmup'}page_content='ax = aapl["Adj. Open"].plot()' metadata={'Header 1': 'plot the Adjusted open to account for stock split'}page_content='fig = ax.get_figure()\n```  \n```python' metadata={'Header 1': 'get the figure so we can re-display the plot after making changes'}page_content='ax.set_title("AAPL Adjusted opening price")  \nfig\n```  \n```python\nax.set_ylim(0, 200)\nfig\n```  \n```python\nax.set_yticks([0, 50, 100, 150, 200])\nfig\n```  \nWe can also create a Figure and Axes beforehand and then tell pandas to\nplot a DataFrame or Series’ data on the axis.  \nWe typically use the `plt.subplots` function to create the Figure and\nAxes.  \nBelow, we use this function to create a Figure that is 10 inches wide by\n6 inches tall and filled with a one by two grid of Axes objects.  \n```python\nfig2, axs2 = plt.subplots(1, 2, figsize=(10, 6))  \nprint("type(fig2): ", type(fig2))\nprint("type(axs): ", type(axs2))\nprint("axs2.shape: ", axs2.shape)\n```  \nWe can plot from our DataFrame directly on our Axes objects by setting\nthe `ax` argument when calling `.plot`.  \n```python\naapl[["Adj. Low", "Adj. High"]].plot(ax=axs2[0])\naapl[["Low", "High"]].plot(ax=axs2[1])\nfig2\n```  \n<a id=\'exercise-1\'></a>\n> See exercise 2 in the [*exercise list*](#exerciselist-0)  \n<a id=\'exercise-2\'></a>\n> See exercise 3 in the [*exercise list*](#exerciselist-0)' metadata={'Header 1': 'set the title'}page_content='Let’s continue on our path to recreating the Financial Times\nvisualization from above.  \nBefore we can actually make the plot, we first have to clean the data.  \nLooking at our goal, we will need share price three days before and\nafter each announcement.  \nWe will also need to normalize the share price to be 100 on the day of\nthe announcement and scale the neighboring days accordingly.  \n```python\nfrom pandas.tseries.holiday import USFederalHolidayCalendar\nfrom pandas.tseries.offsets import CustomBusinessDay  \nbday_us = CustomBusinessDay(calendar=USFederalHolidayCalendar())  \ndef neighbor_dates(date, nbefore=3, nafter=3):' metadata={'Header 1': 'set the title', 'Header 2': 'Data Cleaning'}page_content='date = pd.to_datetime(date)' metadata={'Header 1': 'Make sure the date is a datetime'}page_content='before_and_after = [date + i*bday_us for i in range(-nbefore, nafter+1)]  \nreturn before_and_after  \ndates = []\nfor ann_date in announcement_dates.index:\ndates.extend(neighbor_dates(ann_date))\ndates = pd.Series(dates)' metadata={'Header 1': 'Create a list of business days'}page_content='prices = aapl.loc[dates]\nprices.head()\n```  \nWe now want to bring information on iPhone models into the DataFrame.  \nWe do this by:  \n- Joining on the announcement date. This will introduce a new column\nnamed `Model` which has a value in the announcement date but has 3\n`NaN` above and below each announcement date (a total of 66\n`NaN`)\n- Using the methods `ffill` and `bfill`, we can replace these\n`NaN`s with the corresponding model names.\n- `prices.ffill(limit=3)` will fill the three days *after* the\nannouncement with the model name (down to 33 Nan)\n- `prices.bfill(limit=3)` will fill the three days *before* the\nannouncement with the model name (no more `NaN`)  \n```python\nprices = prices.join(announcement_dates)\nprint(prices["Model"].isnull().sum())\nprices["Model"].head(7)\n```  \n```python\nprices = prices.ffill(limit=3)\nprint(prices["Model"].isnull().sum())\nprices["Model"].head(7)\n```  \n```python\nprices = prices.bfill(limit=3)\nprint(prices["Model"].isnull().sum())\nprices["Model"].head(7)\n```  \nSuccess!  \nNow for the second part of the cleaning: normalize the share price on\neach announcement date to 100 and scale all neighbors accordingly.  \n```python\ndef scale_by_middle(df):' metadata={'Header 1': 'Index into our DataFrame using the new dates'}page_content='N = df.shape[0]' metadata={'Header 1': 'How many rows'}page_content='out = (df["Open"] / df.iloc[N // 2]["Open"]) * 100' metadata={'Header 1': 'rounded to nearest whole number)'}page_content='out.index = list(range(-(N//2), N//2+1))' metadata={'Header 1': 'as the index. Note the +1 because range excludes upper limit'}page_content='out.name = "DeltaDays"\nreturn out\n```  \n```python\nto_plot = prices.groupby("Model").apply(scale_by_middle).T\nto_plot\n```  \nRe-order the columns.  \n```python\nto_plot = to_plot[announcement_dates.values]\nto_plot\n```' metadata={'Header 1': 'also change the name of this series'}page_content='Now that we have cleaned up the data, let’s construct the plot.  \nWe do this by using the DataFrame `.plot` method and then using the\nmatplotlib methods and functions to fine tune our plot, changing one\nfeature or set of features at a time.  \nTo prepare our use of the plot method, we will need to set up some data\nfor what color each line should be, as well as where to draw the tick\nmarks on the vertical axis.  \n```python' metadata={'Header 1': 'also change the name of this series', 'Header 2': 'Constructing the Plot'}page_content='background = tuple(np.array([253, 238, 222]) / 255)\nblue = tuple(np.array([20, 64, 134]) / 255)\npink = tuple(np.array([232, 75, 126]) / 255)  \ndef get_color(x):\nif "S" in x:\nreturn pink\nelse:\nreturn blue  \ncolors = announcement_dates.map(get_color).values' metadata={'Header 1': 'colors'}page_content='yticks = [90, 95, 100, 105, 110, 115]\n```  \nBelow, we construct the basic plot using `to_plot.plot`.  \nNotice that we have specified a few options as keyword arguments to our\nfunction.  \n```python' metadata={'Header 1': 'yticks'}page_content='fig, axs = plt.subplots(1, 11, sharey=True, figsize=(14, 5))' metadata={'Header 1': 'construct figure and Axes objects'}page_content="to_plot.plot(\nax=axs, subplots=True, legend=False,\nyticks=yticks, xticks=[-3, 3],\ncolor=colors, linewidth=3, fontsize=12\n);\n```  \n<a id='exercise-3'></a>\n> See exercise 4 in the [*exercise list*](#exerciselist-0)" metadata={'Header 1': 'because we have one Axes per column'}page_content='That figure has the basic lines we are after, but is quite ugly when\ncompared to the FT figure we are trying to produce.  \nLet’s refine the plot one step at a time.  \nFirst, notice how the `-3` and `3` labels are running into each\nother?  \nThis commonly happens in figures with many subplots.  \nThe function `fig.tight_layout()` will fix these problems – as well\nas most other subplot spacing issues.  \nWe *almost always* call this method when building a plot with multiple\nsubplots.  \n```python' metadata={'Header 1': 'because we have one Axes per column', 'Header 3': 'Subplot Spacing: `fig.tight_layout`'}page_content='fig.tight_layout()\nfig\n```' metadata={'Header 1': 'add some spacing around subplots'}page_content='Now, let’s make the background of our figure match the background of the\nFT post.  \nTo do this, we will use the `fig.set_facecolor` method.  \n```python' metadata={'Header 1': 'add some spacing around subplots', 'Header 3': 'Properties of the Figure'}page_content='fig.set_facecolor(background)\nfig\n```' metadata={'Header 1': 'set background color'}page_content='Notice that this worked for the figure as a whole, but not for any of\nthe Axes.  \nTo fix this, we will need to call `.set_facecolor` on each Axes.  \nWhile we are doing that, let’s fix up a number of other things about the\nAxes:  \n- Add Axes titles\n- Remove the x axis titles\n- Remove tick marks on y axis\n- Add a “faint” version of the line from the first subplot\n- Remove x axis tick labels\n- Make x axis ticks longer and semi-transparent\n- Make sure all Axes have same y limits\n- Remove the spines (the border on each Axes)\n- Add a white circle to (0, 100) on each Axes  \n```python' metadata={'Header 1': 'set background color', 'Header 3': 'Properties of an `Axes`'}page_content='for i in range(announcement_dates.shape[0]):\nax = axs[i]' metadata={'Header 1': 'For each Axes... do the following'}page_content='to_plot["First iPhone"].plot(ax=ax, color=blue, alpha=0.2, linewidth=3)' metadata={'Header 1': 'add faint blue line representing impact of original iPhone announcement'}page_content='ti = str(announcement_dates.index[i].year) + "\\n" + announcement_dates.iloc[i] + "\\n"\nax.set_title(ti)' metadata={'Header 1': 'add a title'}page_content='ax.set_facecolor(background)' metadata={'Header 1': 'set background color of plotting area'}page_content='ax.set_xlabel("")' metadata={'Header 1': 'remove xlabels'}page_content='ax.tick_params(which="both", left=False, labelbottom=False)' metadata={'Header 1': 'turn of tick marks'}page_content='ax.tick_params(axis="x", length=7.0, color=(0, 0, 0, 0.4))' metadata={'Header 1': 'make x ticks longer and semi-transparent'}page_content='ax.set_ylim((yticks[0], yticks[-1]))' metadata={'Header 1': 'set limits on vertical axis'}page_content='ax.plot(0, 100, \'o\', markeredgecolor=blue, markersize=8, color="white", zorder=10)' metadata={'Header 1': 'add a white circle at 0, 100'}page_content='for direction in ["top", "right", "left", "bottom"]:\nax.spines[direction].set_visible(False)  \nfig\n```  \n<a id=\'exercise-4\'></a>\n> See exercise 5 in the [*exercise list*](#exerciselist-0)  \nLet’s continue and add tick labels to the right of the far right\nAxes.  \n```python' metadata={'Header 1': 'remove border around each subplot'}page_content='axs[-1].tick_params(labelright=True, labelsize=12)\naxs[-1]\nfig\n```  \nWe can also add tick labels for the x-axis ticks on the 1st and 6th\nplots.  \n```python\nfor ax in axs[[0, 5]]:\nax.tick_params(labelbottom=True)\nax.set_xticklabels(["3 days\\nbefore", "3 days\\nafter"])' metadata={'Header 1': 'add tick labels to right of iPhone 8/X announcement'}page_content='for label in ax.xaxis.get_ticklabels():\nlabel.set_horizontalalignment("center")  \nfig\n```' metadata={'Header 1': 'instead of the default of right aligned'}page_content='Now we would like to add a horizontal line that lines up with each\nvertical tick label (the numbers from 90 to 115) and runs across the\nentire figure.  \nThis is actually harder than it sounds because most of the “drawing”\ncapabilities of matplotlib are built around drawing on a single Axes and\nwe want to draw across 11 of them.  \nHowever, as we promised above, anything *is* possible and we will show\nyou how to do it.  \nWhen matplotlib draws any data – be it a line, circle, rectangle, or\nother – it must know what *coordinate system* to use.  \nWe typically think about drawing things in the *data’s* coordinate\nsystem (remember above how we added a white circle at (0, 100)).  \nHowever, we might also want to draw using two other coordinate systems:  \n- Figure: the bottom left of the figure is (0, 0) and top right is (1,\n1)\n- Axes: The bottom left of an Axes is (0, 0) and top right is (1, 1)  \nFor our application, we would like to use the figure’s coordinate system\nin the `x` dimension (going across the plot), but the data’s\ncoordinate system in the `y` dimension (so we make sure to put the\nlines at each of our `yticks`).  \nLuckily for us, matplotlib provides a way to use *exactly* that coordinate\nsystem.  \n```python' metadata={'Header 1': 'instead of the default of right aligned', 'Header 3': 'Transforms and Lines'}page_content='trans = transforms.blended_transform_factory(\nfig.transFigure,  # goes across whole figure in x direction\naxs[0].transData  # goes up with the y data in the first axis\n)\n```  \nWe can now use `trans` to draw lines where the `x` values will map\nfrom (0, 1) in the Figure coordinates and the `y` values will go from\n(90, 115) on the data coordinates.  \n```python\nfor y in yticks:\nl = plt.Line2D(' metadata={'Header 1': 'create a transform that...'}page_content='[0.04, 0.985], [y, y],\ntransform=trans,\ncolor="black", alpha=0.4, linewidth=0.5,\nzorder=0.1\n)  \nif y == 100:\nl.set_linewidth(1.5)  \nfig.lines.append(l)  \nfig\n```  \nNow, we need to a add vertical line from the (0, 90) to (0, 100) on the\nfirst axis so we can label the center of each line as the announcement\ndate.  \nWe will split this line in two to leave room for the text `Announced`\nto be added soon.  \nTo add the lines, we will use the data coordinate system from the first\nAxes.  \n```python\nfor y in ([90, 91.5], [93, 100]):\nl = plt.Line2D(\n[0, 0], y,\ntransform=axs[0].transData,\ncolor="black", alpha=0.5, linewidth=1.5, zorder=0.1\n)  \nfig.lines.append(l)\nfig\n```' metadata={'Header 1': 'x values found by trial and error'}page_content='The last step on our journey is to add annotations that mark Tim Cook’s\nfirst announcement as CEO, the lackluster market response to `S` model\nannouncements, and a label showing that the white dot on each subplot is\nassociated with the announcement date.  \nAdding text to figures is always a bit verbose, so don’t get too scared\nby what is happening here.  \n```python\naxs[5].annotate(\n"Tim Cook\'s first iPhone\\nannouncement as Apple\'s CEO",\nxy=(0.2, 99.5), xycoords="data", xytext=(-2, 93),\nannotation_clip=False,\nhorizontalalignment="right",\narrowprops={\n"arrowstyle": "-|>",\n"connectionstyle": "angle3,angleA=0,angleB=110",\n"color": "black"\n},\nfontsize=12,\n)  \nfig\n```  \n```python\nfor ann in axs[8].texts:\nann.remove()  \naxs[8].annotate(\n"Hardware upgrade \'S\' models\\nunderwhelm the market",\nxy=(-5, 99.5), xycoords="data", xytext=(-12, 92),\nannotation_clip=False,\nhorizontalalignment="left",\narrowprops={"visible": False},\nfontsize=12, fontweight="semibold",\ncolor=pink,\n)\naxs[8].set_zorder(0.05)\nfig\n```  \n```python\naxs[0].annotate(\n"Announced",\nxy=(0, 99.5), xycoords="data", xytext=(0, 92),\nannotation_clip=False,\nhorizontalalignment="center",\narrowprops={"visible": False},\nfontsize=12,\n)\nfig\n```' metadata={'Header 1': 'x values found by trial and error', 'Header 3': 'Annotations'}page_content='Now that we have a finished product we are happy with, let’s save it to\na file on our computer using the `fig.savefig` function.  \n```python\nfig.savefig("aapl_iPhone_annoucements.png", dpi=400, bbox_inches="tight", facecolor=background)\n```  \nHere, we asked matplotlib to save our figure in the `png` format, with\n400 dots per inch (`dpi`, meaning each inch has a 400 by 400 set of\ncolored points).  \nThe `bbox_inches` command is needed here to make sure pandas doesn’t\nchop off any of our Axes titles or tick labels.  \nThe `facecolor` argument was necessary because matplotlib\nwill save figures with a transparent background by default (meaning the background\nis see-through so it “adopts” the background color of whatever website,\ndocument, or presentation is is placed in).  \nWe could have chosen a different file format.  \n```python\nfig.savefig("aapl_iPhone_annoucements.jpeg", dpi=400, bbox_inches="tight", facecolor=background)' metadata={'Header 1': 'x values found by trial and error', 'Header 2': 'Saving the Figure'}page_content='fig.savefig("aapl_iPhone_annoucements.pdf", bbox_inches="tight", facecolor=background)' metadata={'Header 1': 'dpi not needed as pdf is a "vector" format that effectively has an infinite dpi'}page_content='fig.savefig("aapl_iPhone_annoucements.svg", bbox_inches="tight", facecolor=background)\n```' metadata={'Header 1': 'svg is also a vector format'}page_content='Phew, we made it!  \nWe ended up writing quite a bit of code to get the figure to look\n*exactly* how we wanted it to look.  \nTypically, our plotting code will be much more concise and simple\nbecause we don’t usually require the same standards for aesthetic\nproperties as professional journalists do.' metadata={'Header 1': 'svg is also a vector format', 'Header 3': 'Summary'}page_content="<a id='exerciselist-0'></a>\n**Exercise 1**  \n**Exercise:** Using the `.plot` method, plot the opening share price\nfor Apple's stock.  \nWhat `type` of object is returned from that method?  \nWhat methods does this object have?  \n```python" metadata={'Header 1': 'svg is also a vector format', 'Header 2': 'Exercises'}page_content='```  \n```python' metadata={'Header 1': 'make plot here'}page_content='```  \n([*back to text*](#exercise-0))  \n**Exercise 2**  \nUsing the `plt.subplots` function, make a Figure with a two-by-one\ngrid of subplots (two rows, one column).  \nOn the upper Axes, plot the adjusted close price.  \nOn the lower one, plot the adjusted volume as an area chart (search for\nan argument on the `plot` method to change the kind of plot).  \nGoogle for how to set a title for a `Figure` object and then do so.  \n([*back to text*](#exercise-1))  \n**Exercise 3**  \nTake 5 minutes to explore the different arguments to the DataFrame `.plot`\nmethod. Try to make a plot that is both good looking and interesting (\nwe know, those are subjective, but do your best!).  \nSome arguments you might consider exploring are:  \n- `sharex` or `sharey`\n- `style`\n- `grid`\n- `color`\n- `kind`  \nHint: You can browse the [official pandas plotting\ndocumentation](https://pandas.pydata.org/pandas-docs/stable/visualization.html)\nfor inspiration.  \n([*back to text*](#exercise-2))  \n**Exercise 4**  \nThink about  what each of the argument we passed to `.plot` does.  \nFor some you might be able to guess, for others you will need to look at\nthe documentation.  \nFor your reference, record your findings in a markdown cell below.  \nHint: Use `to_plot.plot?` to pull up the docs.  \n([*back to text*](#exercise-3))  \n**Exercise 5**  \nFor each operation in the list below (copied from above), make a note\nof which functions/methods were called to achieve the result.\nEdit the markdown cell containing the list directly.  \nNote: This might seem redundant since the comments above give the answers,\nbut forcing yourself to write out the names of the functions will help\nyou remember them when you need them later on.  \n- Change background color\n- Add Axes titles\n- Remove the x axis titles\n- Remove tick marks on y axis\n- Add a "faint" version of the line from the first subplot\n- Remove x axis tick labels\n- Make x axis ticks longer and semi-transparent\n- Make sure all Axes have same y limits\n- Remove the spines (the border on each Axes)\n- Add a white circle to (0, 100) on each Axes  \n([*back to text*](#exercise-4))' metadata={'Header 1': 'explore methods here'}